# 基本概念及操作

ES 作为一个索引及搜索服务，对外提供丰富的 RESTful 接口。如下示例使用 Kibana 操作，PostMan 同理。

## Dev 和 Ops 视角

![image-20200420003109861](./images/image-20200420003109861.png)

*   Index 索引
    *   ~~Type 类型~~
    *   Document 文档

*   Node 节点
    *   Shard 分片





## Index

*   Index 是 **Document 的容器**，是**同一类（7.0 之后只允许为_doc） Document 的集合**。
*   Index 体现了**逻辑**空间的概念
*   每个 Index 都有自己的 **Mapping** 定义，用于定义包含的 **Document 的 Field 名称 和 Field 类型**
*   Index 包括了**分词列表**及**文档列表**
*   Index 就相当于 RDBMS 中的**表**，或相当于 Mongodb 中的**集合**。

::: tip 思考

创建索引库相当于关系数据库中的数据库还是表？

- 如果相当于**数据库**就表示一个索引库可以创建很多不同类型的文档，这在ES中也是允许的（但是 7.0 之后不允许！）

- 如果相当于**表**就表示一个索引库只能存储相同类型的文档，ES官方**建议**在一个索引库中只存**储相同类型的文档**

    | RDBMS  |      ES       |
    | :----: | :-----------: |
    | Table  | Index（Type） |
    |  Row   |   Document    |
    | Column |     Field     |
    | Schema |    Mapping    |
    |  SQL   |      DSL      |

:::

::: tip Index 的不同语义

Indexing （动词）Document 到 ES 的 Index（名词）中

*   名词：一个 ES 集群中，可以创建很多个不同的 Index
*   动词：保存一个 Document 到 ES 的过程也称作 Indexing（ES 创建一个倒排 Index 的过程）
*   名词：一个 B 树 Index，一个倒排 Index

:::



### setting

setting 定义了不同的数据分布（索引的分片，副本）

#### 创建

```bash
# 创建索引，三种选一
POST /my_index/_doc
POST /my_index/_doc/my_id
POST /my_index/_create/my_id
{
    "settings":{
        "index":{
            "number_of_shards":1,
            "number_of_replicas":0
        }
    }
}
```

* `number_of_shards`：设置**分片的数量**，在集群中通常设置多个分片，表示一个索引库将拆分成多片分别存储不同的结点，提高了ES的处理能力和高可用性，入门程序使用单机环境，这里设置为1。

* `number_of_replicas`：设置**副本**的数量，设置副本是为了提高ES的高可靠性，单机环境设置为0。

::: tip 注意

6.0之前的版本有type（类型）概念，相当于关系数据库的表，ES官方将在ES9.0版本中彻底删除type。暂时把type起一个没有特殊意义的名字

:::



### mapping

在 Index 中每个 Document 都包括了一个或多个 Field，创建 mapping 就是向**Index（索引库）**中**创建 Field** 并指定 Field 类型的过程。虽然 ES 会根据 Document 自动设置类型，但是有些 Field 需要自己手动设置！

#### 创建

```bash
# 创建 Index 的 mapping
PUT /my_index/_doc
{
  "mappings": {
        "properties": {
            "name": {
                "type": "text"
            },
            "age": {
                "type": "integer"
            },
            "mail": {
                "type": "keyword"
            },
            "hobby": {
                "type": "text",
                "analyzer": "ik_max_word"
            }
        }
    }
}
```



#### 删除

```bash

```





## ~~Type~~

*   在 7.0 之前，一个 Index 可以设置多个 Types
*   6.0 开始，Type 已经被 Deprecated。7.0 开始一个 Index 只能创建一个 Type：`_doc`







## Document

### 概述

*   ES 是**面向 Document 的**，Document 是所有**可搜索数据的最小单位**
    *   日志文件中的日志项
    *   一本电影的具体信息；一张唱片的详细信息
    *   MP3 播放器里的一首歌；一篇 PDF 文档中的具体内容
*   **Document 会被序列化成 JSON，保存**在 ES 中
    *   **JSON 对象由 Field 组成**
    *   每个 Field 都有对应的类型（字符串、数值、布尔、日期、二进制、范围类型）
*   **每个 Document 都有一个 Unique ID**
    *   可以自己指定 ID
    *   可以通过 ES 自动生成



### JSON Document

*   一篇 Documemt 包含了一系列的 Field，类似数据库中表的一条记录

*   JSON 文档格式灵活，支持数据，支持嵌套，无需预先定义格式。Field 的类型可以指定或通过 ES 自动推算

    

如 CVS 文件转换为。。。



### Document 的元数据

每一篇 Document 都有元数据，用于标注 Document 的相关信息

*   _index：Document 所属的 Index 名
*   _type：Document 所属的 Type 名
*   _id：文档的唯一 ID
*   _source：文档的原始 JSON 数据
*   ~~_all：整合所有 Field 内容到该字段。已被废除~~
*   _version：Document 的版本信息
*   _score：相关性打分

### 创建文档

ES中的文档相当于MySQL数据库表中的==**记录**==。

发送：`put 或Post http://localhost:9200/索引库名称/type/id值`，如果不指定id值ES会自动生成ID。**修改**也是这样！

```json
{
    "name":"Bootstrap开发框架",
    "description":"Bootstrap是由Twitter推出的一个前台页面开发框架，在行业之中使用较为广泛。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。",
    "studymodel":"201001"
}
```

------

`put 或 Post http://localhost:9200/xc_course/doc/4028e58161bcf7f40161bcf8b77c0000`

![1551540000953](images/1551540000953.png)

查看head中数据浏览界面即可看到





### 搜索文档

* 根据课程id查询文档

    `get http://localhost:9200/xc_course/doc/4028e58161bcf7f40161bcf8b77c0000`

* 查询所有记录，利用_search

    `get http://localhost:9200/xc_course/doc/_search`

* 查询名称中包括bootstrap关键字的的记录

    `get http://localhost:9200/xc_course/doc/_search?q=name:bootstrap`

    查询学习模式为201001的记录

    `get http://localhost:9200/xc_course/doc/_search?q=studymodel:201001`

查询结果分析：

```json
{
    "took": 72,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": 1,
        "max_score": 0.2876821,
        "hits": [
            {
                "_index": "xc_course",
                "_type": "doc",
                "_id": "4028e58161bcf7f40161bcf8b77c0000",
                "_score": 0.2876821,
                "_source": {
                    "name": "Bootstrap开发框架",
                    "description": "Bootstrap是由Twitter推出的一个前台页面开发框架，在行业之中使用较为广泛。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。",
                    "studymodel": "201008"
                }
            }
        ]
    }
}
```

took：本次操作花费的时间，单位为毫秒

timed_out：请求是否超时

_shards：说明本次操作共搜索了哪些分片

hits：搜索命中的记录

hits.total ： 符合条件的文档总数 hits.hits ：匹配度较高的前N个文档

hits.max_score：文档匹配得分，这里为最高分

_score：每个文档都有一个匹配度得分，按照降序排列

_source：显示了文档的原始内容









